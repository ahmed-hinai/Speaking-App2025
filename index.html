<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Speaking Practice – Unit 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f8;
      color: #222;
    }

    .app {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 1.1rem;
      margin-top: 0;
      color: #555;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .meta-row label {
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 120px;
    }

    input[type="text"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    .prompt-selector {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .prompt-btn {
      flex: 1;
      min-width: 70px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f0f0f5;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .prompt-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .prompt-text {
      background: #fafafa;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      font-size: 0.95rem;
      line-height: 1.4;
      margin-bottom: 16px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .record {
      background: #dc2626;
      color: white;
      flex: 1;
      min-width: 140px;
    }

    .stop {
      background: #fbbf24;
      color: #222;
      flex: 1;
      min-width: 140px;
    }

    .play {
      background: #16a34a;
      color: white;
      flex: 1;
      min-width: 140px;
    }

    .upload {
      background: #2563eb;
      color: white;
      flex: 1;
      min-width: 140px;
    }

    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .timer {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .status {
      font-size: 0.85rem;
      color: #555;
      min-height: 1.2em;
      margin-top: 4px;
    }

    audio {
      width: 100%;
      margin-top: 8px;
    }

    .footer {
      margin-top: 16px;
      font-size: 0.75rem;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Speaking Practice – Unit 1</h1>
    <h2>Animals – Endangered species & comparisons</h2>

    <div class="meta-row">
      <label>
        Student ID
        <input type="text" id="studentId" placeholder="e.g. 2412345" />
      </label>
      <label>
        Class Code
        <input type="text" id="classCode" value="E423" />
    <h2>Animals – Endangered species & comparisons</h2>

    <div class="meta-row">
      <label>
        Student ID
        <input type="text" id="studentId" placeholder="e.g. 2412345" />
      </label>
      <label>
        Class Code
        <input type="text" id="classCode" value="E423" />
      </label>
    </div>

    <div class="prompt-selector">
      <button class="prompt-btn active" data-prompt="1">Prompt 1</button>
      <button class="prompt-btn" data-prompt="2">Prompt 2</button>
      <button class="prompt-btn" data-prompt="3">Prompt 3</button>
    </div>

    <div id="promptText" class="prompt-text">
      Talk about an endangered animal. Say:
      • where it lives  
      • why it is at risk  
      • what people can do to protect it.
    </div>

    <div class="timer">
      Time: <span id="timerDisplay">00:00</span>
    </div>

    <div class="controls">
      <button id="recordBtn" class="record">Start Recording</button>
      <button id="stopBtn" class="stop disabled">Stop</button>
    </div>

    <button id="playBtn" class="play disabled">Play Recording</button>
    <audio id="audioPlayer" controls style="display:none;"></audio>

    <button id="uploadBtn" class="upload disabled">Download Audio</button>
    <button id="feedbackBtn" class="feedback disabled">Asess Recording</button>
    <div id="feedbackText" class="feedback-text">Loading feedback..</div>
    <div id="status" class="status"></div>


    <div class="footer">
      Your recording, unit, prompt number, student ID, class code, and time will be sent securely to your teacher.
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBHOOK_URL = "https://hook.eu2.make.com/mgiljprq2kdwb4my635a32iq5xwllgv8";
    const UNIT_NAME = "Unit 1";

    const prompts = {
      1: "Talk about an endangered animal. Say:\n• where it lives\n• why it is at risk\n• what people can do to protect it.",
      2: "Talk about your favourite animal. Say:\n• what it looks like\n• where it lives\n• what it eats\n• why you like it.",
      3: "Compare two animals (for example, a lion and a camel). Say:\n• how they are similar\n• how they are different\n• which one you prefer and why."
    };

    // ====== DOM ELEMENTS ======
    const promptButtons = document.querySelectorAll(".prompt-btn");
    const promptTextEl = document.getElementById("promptText");
    const timerDisplay = document.getElementById("timerDisplay");
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playBtn = document.getElementById("playBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("status");
    const studentIdInput = document.getElementById("studentId");
    const classCodeInput = document.getElementById("classCode");
    const audioPlayer = document.getElementById("audioPlayer");

    // ====== STATE ======
    let currentPrompt = 1;
    let mediaRecorder = null;
    let audioChunks = [];
    let timerInterval = null;
    let seconds = 0;
    let recordedBlob = null;
    let studentId = null;
    let classCode = null;

    // ====== PROMPT HANDLING ======
    function setPrompt(promptNumber) {
      currentPrompt = promptNumber;
      promptButtons.forEach(btn => {
        btn.classList.toggle("active", Number(btn.dataset.prompt) === promptNumber);
      });
      promptTextEl.textContent = prompts[promptNumber];
    }

    promptButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const p = Number(btn.dataset.prompt);
        setPrompt(p);
      });
    });

    // ====== TIMER ======
    function startTimer() {
      seconds = 0;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        seconds++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const mins = String(Math.floor(seconds / 60)).padStart(2, "0");
      const secs = String(seconds % 60).padStart(2, "0");
      timerDisplay.textContent = `${mins}:${secs}`;
    }

    // ====== RECORDING ======
    async function startRecording() {
      statusEl.textContent = "Requesting microphone access...";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstart = () => {
          statusEl.textContent = "Recording... speak now.";
          recordBtn.classList.add("disabled");
          recordBtn.disabled = true;

          stopBtn.classList.remove("disabled");
          stopBtn.disabled = false;

          playBtn.classList.add("disabled");
          playBtn.disabled = true;

          uploadBtn.classList.add("disabled");
          uploadBtn.disabled = true;
          feedbackBtn.classList.add("disabled");
          feedbackBtn.disabled = true;


          startTimer();
        };

        mediaRecorder.onstop = () => {
          stopTimer();
          recordedBlob = new Blob(audioChunks, { type: "audio/webm" });
          const audioURL = URL.createObjectURL(recordedBlob);
          audioPlayer.src = audioURL;
          audioPlayer.style.display = "block";

          statusEl.textContent = "Recording finished. You can listen or send it to your teacher.";

          playBtn.classList.remove("disabled");
          playBtn.disabled = false;

          uploadBtn.classList.remove("disabled");
          uploadBtn.disabled = false;
          feedbackBtn.classList.remove("disabled");
          feedbackBtn.disabled = false;
          recordBtn.classList.remove("disabled");
          recordBtn.disabled = false;
        };

        mediaRecorder.start();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Microphone error. Please allow access in your browser settings.";
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        stopBtn.classList.add("disabled");
        stopBtn.disabled = true;
        statusEl.textContent = "Stopping...";
      }
    }

    // ====== PLAYBACK ======
    function playRecording() {
      if (!recordedBlob) {
        statusEl.textContent = "No recording yet.";
        return;
      }
      audioPlayer.play().catch(err => {
        console.error(err);
        statusEl.textContent = "Cannot play audio. Try again.";
      });
    }

// ====== DOWNLOAD AUDIO AND OPEN GOOGLE DRIVE ======
async function uploadRecording() {
  if (!recordedBlob) {
    statusEl.textContent = "Please record something first.";
    return;
  }

  const studentId = studentIdInput.value.trim();
  const classCode = classCodeInput.value.trim();
      formData.append("classCode", classCode);
      formData.append("timestamp", timestamp);
      formData.append("durationSeconds", String(seconds));

      statusEl.textContent = "Uploading... please wait.";

      uploadBtn.classList.add("disabled");
      uploadBtn.disabled = true;

      try {
        const url = URL.createObjectURL(recordedBlob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        a.click();


        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        

        const googleDriveFolderUrl = "https://drive.google.com/drive/folders/1Vhk_9L1Cbbyedz4TZULG74alHmfzpwhK";
        window.open(googleDriveFolderUrl, '_blank');

        statusEl.innerHTML = '
        Download complete!<br>
        File: $(filename)<br>
        Google Drive folder opened. Please upload your audio file.
        '
        })
        });

        if (!res.ok) {
          throw new Error("Upload failed with status " + res.status);
        }

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Upload error. Please try again later.";
        uploadBtn.classList.remove("disabled");
        uploadBtn.disabled = false;
      }
    }

    // ====== EVENT LISTENERS ======
    recordBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
    playBtn.addEventListener("click", playRecording);
    uploadBtn.addEventListener("click", uploadRecording);
  </script>
</body>
</html>
