<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Speaking App ‚Äì Unit 1</title>
  <style>
    :root { --w: 760px; }
    body { font-family: system-ui, Arial, sans-serif; max-width: var(--w); margin: 24px auto; padding: 0 12px; line-height: 1.4; }
    h1 { margin: 0 0 6px; }
    .muted { color: #555; font-size: 0.95rem; margin-top: 0; }
    .row { margin: 12px 0; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
    textarea { resize: vertical; }
    button { padding: 10px 14px; border: 1px solid #ccc; border-radius: 999px; background: #f7f7f7; cursor: pointer; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .stack { display: flex; gap: 8px; flex-wrap: wrap; }
    .status { font-size: 0.95rem; }
    .ok { color: #0a7a0a; }
    .err { color: #a00; }
    .box { border: 1px dashed #ddd; border-radius: 10px; padding: 10px; background: #fafafa; }
  </style>
</head>
<body>
  <h1>Speaking App ‚Äì Unit 1</h1>
  <p class="muted">Choose a prompt, record your answer, then upload.</p>

  <!-- ====== CONFIG ====== -->
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzkh6iYdSuMnGNZKBJHYs2oYpXAfSzDj9MV0SIRsmrZfeMxjw2UdYFt78YFQIeBcPTl/exec";
    const TOKEN   = "E423_SECRET_2025";

    // Unit 1 prompts (edit anytime)
    const PROMPTS = {
      easy:   "Describe an endangered animal. Say where it lives, one reason it is at risk, and one way people can help.",
      medium: "Talk about an endangered animal in more detail: habitat, main threats, and two practical actions people or governments can take.",
      hard:   "Explain the causes and consequences of endangerment for one species. Evaluate which conservation measures are most effective and why."
    };
  </script>
  <!-- ===================== -->

  <div class="row">
    <label>Your name</label>
    <input id="name" placeholder="First Last" />
  </div>

  <div class="row">
    <label>Class / Level</label>
    <input id="level" placeholder="E423" value="E423" />
  </div>

  <div class="row">
    <label>Prompt level</label>
    <select id="promptLevel">
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
  </div>

  <div class="row">
    <label>Prompt (Unit 1)</label>
    <textarea id="prompt" rows="3" readonly></textarea>
  </div>

  <div class="row box">
    <div class="stack">
      <button id="btnStart">üéôÔ∏è Start</button>
      <button id="btnStop" disabled>‚èπÔ∏è Stop</button>
      <button id="btnPlay" disabled>‚ñ∂Ô∏è Play</button>
    </div>
    <div class="row">
      <audio id="player" controls></audio>
    </div>
    <div class="stack">
      <div>
        <label>Duration (seconds)</label>
        <input id="seconds" type="number" readonly />
      </div>
      <div>
        <label>Estimated words (optional)</label>
        <input id="words" type="number" placeholder="e.g., 75" />
      </div>
    </div>
  </div>

  <div class="row">
    <label>Optional: Transcript (type what you said)</label>
    <textarea id="transcript" rows="4" placeholder="Write what you said (optional)"></textarea>
  </div>

  <div class="row stack">
    <button id="btnUpload" disabled>‚¨ÜÔ∏è Upload to Teacher</button>
    <span id="status" class="status"></span>
  </div>

  <div class="row muted">
    If the mic prompt doesn‚Äôt appear, check: Site settings ‚Üí Microphone ‚Üí Allow while visiting this site.
  </div>

  <script>
    // ----- wire prompts -----
    const el = id => document.getElementById(id);
    const nameEl = el('name');
    const levelEl = el('level');
    const promptEl = el('prompt');
    const promptLevelEl = el('promptLevel');
    const transcriptEl = el('transcript');
    const wordsEl = el('words');
    const secondsEl = el('seconds');
    const player = el('player');
    const statusEl = el('status');
    const bStart = el('btnStart');
    const bStop = el('btnStop');
    const bPlay = el('btnPlay');
    const bUpload = el('btnUpload');

    // initialize prompt
    function setPromptFromLevel() {
      const lvl = promptLevelEl.value;
      promptEl.value = PROMPTS[lvl] || "";
    }
    promptLevelEl.addEventListener('change', setPromptFromLevel);
    setPromptFromLevel();

    // ----- helpers -----
    let mediaRecorder, chunks = [], recordedBlob = null, startedAt = null;

    function setStatus(msg, type) {
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (type ? " " + type : "");
    }

    function safeSlug(s, max=24) {
      return s.slice(0, max).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function makeFilename(name, prompt, lvl) {
      const safeName = safeSlug(name, 32);
      const shortPrompt = safeSlug(prompt, 24);
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      return `${safeName}-u1-${lvl}-${shortPrompt}-${ts}`;
    }

    // ----- recording -----
    bStart.addEventListener('click', async () => {
      setStatus("");
      chunks = []; recordedBlob = null; player.src = "";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
          recordedBlob = new Blob(chunks, { type: 'audio/webm' });
          player.src = URL.createObjectURL(recordedBlob);
          bPlay.disabled = false;
          bUpload.disabled = false;
          const secs = Math.max(1, Math.round((Date.now() - startedAt) / 1000));
          secondsEl.value = secs;
          setStatus("Stopped. Ready to upload.");
        };
        mediaRecorder.start();
        startedAt = Date.now();
        bStart.disabled = true;
        bStop.disabled = false;
        bPlay.disabled = true;
        bUpload.disabled = true;
        setStatus("Recording‚Ä¶");
      } catch (err) {
        setStatus("Mic blocked or unavailable: " + err, "err");
      }
    });

    bStop.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        bStart.disabled = false;
        bStop.disabled = true;
      }
    });

    bPlay.addEventListener('click', () => {
      if (player.src) player.play();
    });

    // ----- upload -----
    bUpload.addEventListener('click', async () => {
      if (!recordedBlob) return setStatus("Nothing recorded yet.", "err");
      if (!nameEl.value.trim()) return setStatus("Please enter your name.", "err");
      if (!GAS_URL || GAS_URL.indexOf("/exec") === -1) return setStatus("GAS_URL missing or not /exec.", "err");

      const lvl = promptLevelEl.value;
      const filename = makeFilename(nameEl.value, promptEl.value, lvl);

      const fd = new FormData();
      fd.append('token', TOKEN);
      fd.append('name', nameEl.value.trim());
      fd.append('unit', 'Unit 1');
      fd.append('level', levelEl.value.trim());
      fd.append('prompt', `[${lvl}] ${promptEl.value.trim()}`);
      fd.append('transcript', transcriptEl.value.trim());
      fd.append('words', wordsEl.value.trim());
      fd.append('seconds', secondsEl.value.trim());
      fd.append('overall', '');
      fd.append('grammar_ok', '');
      fd.append('keyword_hits', '');
      fd.append('audio', recordedBlob, filename + '.webm');

      try {
        setStatus("Uploading‚Ä¶");
        bUpload.disabled = true;
        const res = await fetch(GAS_URL, { method: 'POST', body: fd });
        const json = await res.json().catch(() => ({}));
        if (json && json.ok) {
          setStatus("Uploaded ‚úì Link saved in Sheet.", "ok");
        } else {
          setStatus("Upload failed: " + (json.error || res.status + " " + res.statusText), "err");
          bUpload.disabled = false;
        }
      } catch (err) {
        setStatus("Network error: " + err, "err");
        bUpload.disabled = false;
      }
    });
  </script>
</body>
</html>


